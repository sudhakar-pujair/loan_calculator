<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <title>EMI Result</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <style>
        body { font-family: Arial; background: #eef1f5; padding: 40px; }
        .box { background: white; padding: 20px; border-radius: 10px;
               box-shadow: 0 4px 16px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 8px; border: 1px solid #ccc; text-align: right; }
        th { background: #007bff; color: white; text-align: center; }
        h3 { text-align: center; }
        .btn { padding: 10px 20px; background: #007bff; color: white;
               border: none; border-radius: 6px; cursor: pointer; margin-top: 20px; }
    </style>
</head>

<body>

<div class="box">
    <h3>EMI Schedule Result</h3>

    <div id="summary"></div>
    <table id="emiTable">
        <thead>
            <tr>
                <th>Month</th>
                <th>Opening Principal</th>
                <th>EMI</th>
                <th>Principal Repaid</th>
                <th>Interest</th>
                <th>Closing Principal</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button class="btn" onclick="downloadExcel()">Download Excel</button>
</div>

<script>
    const principal = Number(localStorage.getItem("principal"));
    const emi = Number(localStorage.getItem("emi"));
    const rate = Number(localStorage.getItem("rate"));

    let balance = principal;
    const monthlyRate = rate / 12 / 100;
    let month = 0;
    let lastEmi = emi;

    let rows = [
        ["Month", "Opening Principal", "EMI", "Principal Repaid", "Interest", "Closing Principal"]
    ];

    const tbody = document.querySelector("#emiTable tbody");

    while (balance > 0) {
        month++;
        const interest = balance * monthlyRate;

        let principalRepaid, closingBalance;

        if (balance + interest < emi) {
            lastEmi = balance + interest;
            principalRepaid = balance;
            closingBalance = 0;
        } else {
            principalRepaid = emi - interest;
            closingBalance = balance - principalRepaid;
            lastEmi = emi;
        }

        rows.push([
            month,
            balance.toFixed(2),
            lastEmi.toFixed(2),
            principalRepaid.toFixed(2),
            interest.toFixed(2),
            closingBalance.toFixed(2)
        ]);

        const tr = document.createElement("tr");
        tr.innerHTML = `
            <td style="text-align:center">${month}</td>
            <td>${balance.toFixed(2)}</td>
            <td>${lastEmi.toFixed(2)}</td>
            <td>${principalRepaid.toFixed(2)}</td>
            <td>${interest.toFixed(2)}</td>
            <td>${closingBalance.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);

        balance = closingBalance;
    }

    const totalInterest = (emi * (month - 1) + lastEmi) - principal;

    document.getElementById("summary").innerHTML = `
        <p><strong>Principal:</strong> ₹${principal.toLocaleString()}</p>
        <p><strong>EMI:</strong> ₹${emi.toLocaleString()}</p>
        <p><strong>Interest Rate:</strong> ${rate}%</p>
        <p><strong>Total Months:</strong> ${month}</p>
        <p><strong>Total Interest Paid:</strong> ₹${totalInterest.toLocaleString()}</p>
    `;

    // Excel Download
    function downloadExcel() {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(rows);
        XLSX.utils.book_append_sheet(wb, ws, "EMI Schedule");

        XLSX.writeFile(wb, `emi_schedule_${principal}.xlsx`);
    }
</script>

</body>
</html>
